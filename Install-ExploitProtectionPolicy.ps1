#Requires -RunAsAdministrator
Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

# Source folder
$srcFolder = Split-Path -Parent $Myinvocation.mycommand.path
$srcFile = Join-Path $srcFolder -ChildPath 'EP.xml'
$destFolder = Join-Path $Env:windir -ChildPath 'EP'
$destFile = Join-Path $destFolder -ChildPath 'EP.xml'

# Create the destination folder
if (-Not (Test-Path $destFolder)) {
    try {
        New-Item -Path $destFolder -ItemType Directory -Force
    }
    catch {
        Write-Warning 'Unable to create the destination folder, aborting...'
        Pause
        exit 1
    }
}

# Copy the policy file
try {
    Copy-Item -Path $srcFile -Destination $destFile -Force
}
catch {
    Write-Warning 'Unable to copy the policy file, aborting...'
    Pause
    exit 1
}

if (-Not (Test-Path 'HKLM:\Software\Policies\Microsoft\Windows Defender ExploitGuard\Exploit Protection')) {
    New-Item -Path 'HKLM:\Software\Policies\Microsoft\Windows Defender ExploitGuard\Exploit Protection' -Force | Out-Null
}

try {
    Set-ProcessMitigation -PolicyFilePath $destFile
    Set-ItemProperty -Path 'HKLM:\Software\Policies\Microsoft\Windows Defender ExploitGuard\Exploit Protection' -Name 'ExploitProtectionSettings' -Value "$destFile" -Force | Out-Null
}
catch {
    Write-Warning 'Unable to apply the new policy...'
    $string_err = $_ | Out-String
    Write-Output "Exception: $string_err"
    Pause
    exit 1
}

Write-Host -ForegroundColor Green "Installation successful, please restart your computer for changes to take effect ! :)"